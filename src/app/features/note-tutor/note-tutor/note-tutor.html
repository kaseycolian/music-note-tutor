<div class="note-tutor-container">
  <!-- Game Header -->
  <header class="game-header">
    <h1>
      <span class="line-1">NOTE AND SEEK</span>
      <span>
        <span class="line-2">THE MUSIC NOTE TUTOR</span>
      </span>

    </h1>
  </header>

  <!-- Progress Display -->
  <section class="progress-section" aria-labelledby="progress-heading">
    <h2 id="progress-heading" class="sr-only">Your Progress</h2>
    @if (userProgress(); as progress) {
      <div class="stats-grid">
        <div class="stat-line options-stat-line">
          <!-- Difficulty Selector -->
          <div class="stat-item difficulty-selector">
            <span class="stat-label">Level</span>
            <div class="difficulty-dropdown">
              <button
                #difficultyDropdownButton
                type="button"
                class="stat-value level-badge difficulty-button"
                (click)="toggleDifficultyDropdown()"
                [attr.aria-expanded]="showDifficultyDropdown()"
                [attr.aria-label]="'Select difficulty mode. Current: ' + getCurrentDifficultyLabel()">
                {{ getCurrentDifficultyLabel() }}
                <span class="dropdown-arrow">â–¼</span>
              </button>
              @if (showDifficultyDropdown()) {
                <ul class="difficulty-menu" role="menu" cdkTrapFocus [cdkTrapFocusAutoCapture]="true" (keydown)="onMenuKeydown($event)">
                  @for (mode of difficultyModes; track mode.mode) {
                    <li >
                      <button
                        tabindex="0"
                        type="button"
                        class="difficulty-option"
                        [class.active]="difficultyMode() === mode.mode"
                        (click)="selectDifficulty($event, mode.mode, difficultyDropdownButton)"
                        role="menuitem">
                        <span class="option-label">{{ mode.label }}</span>
                        <span class="option-description">{{ mode.description }}</span>
                      </button>
                    </li>
                  }
                </ul>
              }
            </div>
          </div>
          <!-- Clef Selector -->
          <div class="stat-item difficulty-selector">
            <span class="stat-label">Clef</span>
            <div class="difficulty-dropdown">
              <button
                #clefDropdownButton
                type="button"
                class="stat-value level-badge difficulty-button"
                (click)="toggleClefDropdown()"
                [attr.aria-expanded]="showClefDropdown()"
                [attr.aria-label]="'Select clef filter. Current: ' + getCurrentClefLabel()">
                {{ getCurrentClefLabel() }}
                <span class="dropdown-arrow">â–¼</span>
              </button>
              @if (showClefDropdown()) {
                <ul class="difficulty-menu" role="menu"  cdkTrapFocus [cdkTrapFocusAutoCapture]="true" (keydown)="onMenuKeydown($event)">
                  @for (clef of clefFilters; track clef.filter) {
                    <li>
                      <button
                        type="button"
                        class="difficulty-option"
                        [class.active]="clefFilter() === clef.filter"
                        (click)="selectClef($event, clef.filter, clefDropdownButton)"
                        role="menuitem">
                        <span class="option-label">{{ clef.label }}</span>
                        <span class="option-description">{{ clef.description }}</span>
                      </button>
                    </li>

                  }
                </ul>
              }
            </div>
          </div>
          <!-- Note Selector -->
          <div class="stat-item difficulty-selector">
            <span class="stat-label">Note</span>
            <div class="difficulty-dropdown">
              <button
                #noteDropdownButton
                type="button"
                class="stat-value level-badge difficulty-button"
                (click)="toggleNoteDropdown()"
                [attr.aria-expanded]="showNoteDropdown()"
                [attr.aria-label]="'Select note filter. Current: ' + getCurrentNoteLabel()">
                {{ getCurrentNoteLabel() }}
                <span class="dropdown-arrow">â–¼</span>
              </button>
              @if (showNoteDropdown()) {
                <ul class="difficulty-menu" role="menu" cdkTrapFocus [cdkTrapFocusAutoCapture]="true" (keydown)="onMenuKeydown($event)">
                  @for (note of noteFilters; track note.filter) {
                    <li>
                      <button
                        type="button"
                        class="difficulty-option"
                        [class.active]="noteFilter() === note.filter"
                        (click)="selectNote($event, note.filter, noteDropdownButton)"
                        role="menuitem">
                        <span class="option-label">{{ note.label }}</span>
                        <span class="option-description">{{ note.description }}</span>
                      </button>
                    </li>
                  }
                </ul>
              }
            </div>
          </div>
        </div>
        <div class="stat-line">
          <div class="stat-item">
            <span class="stat-label">Overall Accuracy:</span>
            <span class="stat-value accuracy-display" [class.high-accuracy]="accuracyPercentage() >= 80">
              {{ accuracyPercentage() }}%
            </span>
          </div>
          <div class="stat-item">
            <span class="stat-label">Question Number:</span>
            <span class="stat-value">{{ progress.totalQuestionsAnswered }}</span>
          </div>
        </div>
      </div>
    }
  </section>

  <!-- Main Game Area -->
  <main class="game-area" role="main">
    <!-- Musical Staff Display -->
    <section class="staff-section" aria-labelledby="staff-heading">
      <h2 id="staff-heading" class="sr-only">Musical Staff</h2>
      @if (currentNote(); as note) {
        <app-musical-staff
          [currentNote]="note"
          [clef]="note.clef"
          [showNote]="true"
          [showResult]="feedback()?.type === 'correct'"
          class="staff-container" />
      } @else {
        <div class="staff-placeholder" role="status" aria-live="polite">
          <p>Loading musical note...</p>
        </div>
      }
    </section>

    <!-- Answer Input Section -->
    <section class="input-section" aria-labelledby="input-heading">
      @if (showAnswerInput()) {
        <div class="input-container">
          <h2 class="instruction-text">Which note is displayed on the staff?</h2>
          <app-note-input
            #noteInputComponent
            [availableNotes]="filteredAvailableNotes()"
            [disabled]="isProcessing()"
            (noteSelected)="handleAnswer($event)"
            class="answer-input" />
        </div>
      } @else if (isProcessing()) {
        <div class="processing-state" role="status" aria-live="polite">
          <div class="loading-spinner" aria-hidden="true"></div>
          <p>Processing your answer...</p>
        </div>
      }
    </section>

    <!-- Control Buttons -->
    <section class="controls-section" aria-labelledby="controls-heading">
      <div class="controls">
        <button
          #nextNoteButton
          type="button"
          (click)="generateNewNote($event)"
          [disabled]="!canGenerateNew()"
          class="btn btn-primary">
          @if (hasAnswered()) {
            Next Note
          } @else {
            New Note
          }
        </button>

        @if (showAnswerInput()) {
          <button
            type="button"
            (click)="showAnswer()"
            class="btn btn-secondary"
            [attr.aria-label]="'Reveal the correct answer for this note'">
            {{showAnswerHint() ? 'Hide Answer Hint' : 'Show Answer Hint'}}
          </button>
        }

      </div>
    </section>

      <!-- Feedback Display -->
    @if (feedback(); as feedbackData) {
      <section class="feedback-section" aria-labelledby="feedback-heading">
        <h2 id="feedback-heading" class="sr-only">Answer Feedback</h2>
        <div class="feedback-container">
          @switch (feedbackData.type) {
            @case ('correct') {
              <div class="feedback success" role="alert" aria-live="assertive">
                <span class="feedback-icon" aria-hidden="true">âœ“</span>
                <span class="feedback-message">{{ feedbackData.message }}</span>
              </div>
            }
            @case ('incorrect') {
              <div class="feedback error" role="alert" aria-live="assertive">
                <span class="feedback-icon" aria-hidden="true">âœ—</span>
                <span class="feedback-message">{{ feedbackData.message }}</span>
              </div>
            }
            @case ('hint') {
              <div class="feedback hint" role="status" aria-live="polite">
                <span class="feedback-icon" aria-hidden="true">ðŸ’¡</span>
                <span class="feedback-message">{{ feedbackData.message }}</span>
              </div>
            }
          }
        </div>
      </section>
    }

    <section class="reset-controls">
      <button
        type="button"
        (click)="resetProgress()"
        class="btn btn-outline"
        [attr.aria-label]="'Reset all progress'">
        Reset Progress
      </button>
    </section>
  </main>

  <!-- Instructions Panel -->
  <aside class="instructions-panel" aria-labelledby="instructions-heading">
    <h2 id="instructions-heading">How to Play</h2>
    <div class="instructions-content">
      <ol class="instructions-list">
        <li class="instruction-header">Choose your <strong>Difficulty</strong> level:
          <ul>
            <li><strong>Default:</strong> All note positions (staff + ledger lines)</li>
            <li><strong>Easy:</strong> Only notes on the staff lines and spaces</li>
            <li><strong>Hard:</strong> Only notes on ledger lines above and below staff</li>
          </ul>
        </li>
        <li class="instruction-header">Select your <strong>Clef</strong> preference:
          <ul>
            <li><strong>Both:</strong> Practice treble and bass clef notes</li>
            <li><strong>Treble:</strong> Focus on treble clef only</li>
            <li><strong>Bass:</strong> Focus on bass clef only</li>
          </ul>
        </li>
        <li class="instruction-header">Choose a <strong>Note</strong> to practice:
          <ul>
            <li><strong>All:</strong> Practice all notes (C through B)</li>
            <li><strong>C, D, E, F, G, A, or B:</strong> Focus on a single note for targeted practice</li>
          </ul>
        </li>
        <li>Look at the note displayed on the musical staff</li>
        <li>Identify which note it represents</li>
        <li>Click on your answer from the available options</li>
        <li>Get instant feedback and track your progress</li>
      </ol>

      <div class="tips-section">
        <h3>Tips for Success:</h3>
        <ul class="tips-list">
          <li>Start with <strong>Easy</strong> difficulty and a single <strong>Note</strong> to build confidence</li>
          <li>Use mnemonics like "Every Good Boy Does Fine" for treble clef lines</li>
          <li>Practice one clef and one note at a time before combining</li>
          <li>Once comfortable with individual notes, switch to <strong>All</strong> notes for full practice</li>
          <li>Progress to <strong>Hard</strong> difficulty to master ledger lines</li>
          <li>Practice regularly to build muscle memory</li>
          <li>Don't worry about mistakes - they help you learn!</li>
        </ul>
      </div>
    </div>
  </aside>
</div>
