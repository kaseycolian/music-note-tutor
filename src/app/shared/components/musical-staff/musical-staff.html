<div class="musical-staff-container" [attr.aria-label]="'Musical staff displaying ' + (currentNote()?.name || 'no note')">
  <!-- Screen reader label for staff -->
  <div class="sr-only" role="status" aria-live="assertive" aria-atomic="true">
    @if (currentNote(); as note) {
      Musical staff in {{ clef() }} clef showing a note in octave {{ note.octave }}.
    } @else {
      Musical staff in {{ clef() }} clef with no note displayed.
    }
  </div>

  <svg
    [attr.viewBox]="'0 0 ' + staffWidth + ' ' + staffHeight"
    preserveAspectRatio="xMidYMid slice"
    class="staff-svg"
    role="img"
    aria-hidden="true">

    <!-- Staff lines -->
    @for (lineY of staffLinePositions(); track lineY) {
      <line
        x1="50"
        [attr.y1]="lineY"
        [attr.x2]="staffWidth - 50"
        [attr.y2]="lineY"
        class="staff-line"
        stroke="#000"
        stroke-width="2" />
    }

    <!-- Clef symbol -->
    <text
      x="90"
      [attr.y]="clef() === 'bass' ? staffCenterY + 28 : staffCenterY + 15"
      class="clef-symbol"
      font-family="serif"
      [attr.font-size]="clef() === 'bass' ? '70' : '85'"
      fill="#000"
      text-anchor="middle">
      {{ clefSymbol() }}
    </text>

    <!-- Ledger lines -->
    @if (showNote() && currentNote(); as note) {
      @for (ledger of ledgerLines(); track ledger.y) {
        <line
          [attr.x1]="ledger.x1"
          [attr.y1]="ledger.y"
          [attr.x2]="ledger.x2"
          [attr.y2]="ledger.y"
          class="ledger-line"
          stroke="#000"
          stroke-width="2" />
      }
    }

    <!-- Note display -->
    @if (showNote() && noteDisplayPosition(); as position) {
      <!-- Accidental (if present) -->
      @if (shouldShowAccidental() && getAccidentalPosition(); as accidentalPos) {
        <text
          [attr.x]="accidentalPos.x"
          [attr.y]="accidentalPos.y + 6"
          class="accidental"
          font-family="serif"
          font-size="20"
          fill="#000"
          text-anchor="middle">
          {{ getAccidentalSymbol(currentNote()!.accidental!) }}
        </text>
      }
      <!-- Note head -->
      <g [attr.transform]="'translate(' + position.x + ',' + position.y + ') rotate(20) scale(1.2, 1.1)'">
        <ellipse
          cx="0"
          cy="0"
          [attr.rx]="noteRadius"
          [attr.ry]="noteRadius * 0.7"
          class="note"
          fill="none"
          stroke="#000"
          stroke-width="3.5" />
      </g>

    }

    <!-- Visual feedback for empty state -->
    @if (!showNote() || !currentNote()) {
      <text
        [attr.x]="staffCenterX"
        [attr.y]="staffCenterY"
        class="placeholder-text"
        font-family="Arial, sans-serif"
        font-size="16"
        fill="#666"
        text-anchor="middle">
        Click "New Note" to start
      </text>
    }
  </svg>

  <!-- Note information panel -->
  @if (showResult() && currentNote(); as note) {
    <div class="note-info" role="status" aria-live="polite">
      <span class="note-name">{{ note.name }}</span>
      @if (note.accidental) {
        <span class="note-accidental">{{ getAccidentalSymbol(note.accidental) }}</span>
      }
      <span class="note-octave">{{ note.octave }}</span>
    </div>
  }
</div>
